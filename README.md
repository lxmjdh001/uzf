# OKX 账户交易资金变动监控工具

这是一个用于监控OKX交易所账户资金变动的Python脚本,可以实时监控账单流水,并在检测到资金变动时输出详细信息。

## 功能特点

- ✅ 实时监控账户资金变动
- ✅ 支持实盘和模拟盘
- ✅ 显示监控时间戳、变动金额、产生时间
- ✅ 支持按产品类型过滤(币币、杠杆、合约等)
- ✅ 自动去重,避免重复处理
- ✅ 详细的账单类型说明

## 安装依赖

```bash
pip install requests
```

## 配置说明

### 1. 创建OKX API Key

1. 登录 [OKX官网](https://www.okx.com)
2. 进入 **个人中心** -> **API管理**
3. 点击 **创建API Key**
4. 设置API权限(至少需要**读取**权限)
5. 记录以下信息:
   - API Key
   - Secret Key (只显示一次,请妥善保管)
   - Passphrase (创建时设置的密码)

### 2. 配置脚本

编辑 `okx_monitor.py` 文件,在 `main()` 函数中填入你的API信息:

```python
API_KEY = "your_api_key_here"          # 你的API Key
SECRET_KEY = "your_secret_key_here"    # 你的Secret Key
PASSPHRASE = "your_passphrase_here"    # 你的API密码
IS_DEMO = False                         # True=模拟盘, False=实盘
```

### 3. 监控配置

```python
MONITOR_INTERVAL = 10  # 监控间隔(秒)
INST_TYPE = None       # 产品类型过滤
```

**产品类型选项:**
- `None` - 监控所有类型
- `"SPOT"` - 仅监控币币交易
- `"MARGIN"` - 仅监控杠杆交易
- `"SWAP"` - 仅监控永续合约
- `"FUTURES"` - 仅监控交割合约
- `"OPTION"` - 仅监控期权

## 使用方法

### 基本使用

```bash
python okx_monitor.py
```

### 输出示例

```
开始监控OKX账户资金变动...
监控间隔: 10秒
产品类型: 全部
--------------------------------------------------------------------------------

================================================================================
【资金变动监控】
监控时间戳: 1699876543210
监控时间: 2024-11-12 15:30:45
账单产生时间: 2024-11-12 15:30:40
账单时间戳: 1699876540000
变动金额: -0.5 USDT
当前余额: 1000.5 USDT
交易产品: BTC-USDT
账单类型: 交易 - 买入
账单ID: 123456789
================================================================================
```

## 返回数据说明

每次检测到资金变动时,会输出以下信息:

| 字段 | 说明 |
|------|------|
| 监控时间戳 | 检测到变动的当前时间戳(毫秒) |
| 监控时间 | 检测到变动的当前时间(格式化) |
| 账单产生时间 | 资金变动实际发生的时间 |
| 账单时间戳 | 资金变动实际发生的时间戳(毫秒) |
| 变动金额 | 资金变动数量(正数=增加,负数=减少) |
| 当前余额 | 变动后的账户余额 |
| 交易产品 | 相关的交易产品(如BTC-USDT) |
| 账单类型 | 变动类型(交易、划转、资金费等) |
| 账单ID | 唯一账单标识 |

## 账单类型说明

脚本会自动识别并显示以下账单类型:

- **交易** - 买入/卖出/开多/开空/平多/平空
- **划转** - 账户间资金划转
- **资金费** - 永续合约资金费用
- **交割** - 合约交割
- **借币/还币** - 杠杆借币和还币
- **利息** - 借币利息
- **强平** - 强制平仓
- **其他** - 其他类型的资金变动

## API接口说明

本脚本使用OKX官方API v5接口:

- **账单流水查询(近7天)**: `GET /api/v5/account/bills`
- **限速**: 6次/秒
- **权限**: 需要API Key具有读取权限

## 注意事项

⚠️ **安全提示:**
1. 请妥善保管你的API Key和Secret Key
2. 建议只授予**读取**权限,不要授予交易和提币权限
3. 不要将包含真实API信息的代码上传到公开仓库
4. 建议使用IP白名单限制API访问

⚠️ **使用限制:**
1. 账单流水查询接口限速为 6次/秒
2. 默认只能查询近7天的数据
3. 每次最多返回100条记录

⚠️ **其他说明:**
1. 首次运行会获取最近的账单,之后只监控新增账单
2. 建议监控间隔不要设置太短,避免触发限速
3. 如需查询更长时间的历史数据,可使用 `/api/v5/account/bills-archive` 接口

## 高级用法

### 使用配置文件

1. 复制配置文件示例:
```bash
cp config_example.py config.py
```

2. 编辑 `config.py` 填入你的API信息

3. 修改 `okx_monitor.py` 导入配置:
```python
from config import OKX_CONFIG, MONITOR_CONFIG

monitor = OKXMonitor(
    api_key=OKX_CONFIG['api_key'],
    secret_key=OKX_CONFIG['secret_key'],
    passphrase=OKX_CONFIG['passphrase'],
    is_demo=OKX_CONFIG['is_demo']
)
```

### 自定义处理逻辑

你可以修改 `_process_bill()` 方法来实现自定义的处理逻辑,例如:

- 发送邮件通知
- 写入数据库
- 触发交易策略
- 发送Webhook通知

## 故障排查

### 1. 签名错误

```
API错误: Invalid signature
```

**解决方法:**
- 检查API Key、Secret Key和Passphrase是否正确
- 确认系统时间准确(误差不超过30秒)

### 2. 权限错误

```
API错误: Permission denied
```

**解决方法:**
- 确认API Key具有读取权限
- 检查IP白名单设置

### 3. 限速错误

```
API错误: Rate limit exceeded
```

**解决方法:**
- 增加监控间隔时间
- 减少每次查询的记录数量

## 参考文档

- [OKX API官方文档](https://www.okx.com/docs-v5/zh/)
- [账单流水查询接口](https://www.okx.com/docs-v5/zh/#trading-account-rest-api-get-bills-details-last-7-days)

## 许可证

MIT License

## 免责声明

本工具仅供学习和研究使用,使用本工具进行交易的风险由使用者自行承担。作者不对使用本工具造成的任何损失负责。

